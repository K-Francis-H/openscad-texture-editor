<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<script>
			class Canvas {
				constructor(canvasId, virtualSize){
					this.canvas = document.getElementById("canvas");
					this.REAL_WIDTH = this.canvas.width;
					this.REAL_HEIGHT = this.canvas.height;
					this.ctx = this.canvas.getContext("2d");

					this.pixw = this.REAL_WIDTH / virtualSize;
					this.pixh = this.REAL_HEIGHT / virtualSize;
					this.virtualSize = virtualSize;

					this.state = [];
					for(let i=0; i < this.virtualSize; i++){
						this.state[i] = [];
						for(let j=0; j < this.virtualSize; j++){
							this.state[i][j] = 0;
						}
					}

					//probably want a
					var self = this;
					
					self.canvas.addEventListener("click", this.handleCanvasClickEvent(this));
				}

				//a closure to make sure we have access to the class 'this' not the this.canvas 'this'
				handleCanvasClickEvent(self){
					return function(event){
						let rect = event.target.getBoundingClientRect();
						let x = event.clientX - rect.left;
						let y = event.clientY - rect.top;
						console.log(x);
						console.log(y);
						console.log(this);
						console.log(self);
						console.log(self.calcVirtualPixel(x,y));
						let coords = self.calcVirtualPixel(x,y);
						self.paintPixel(coords[0], coords[1])
					}
				}

				/*handleClickEvent(event){
					//get the canvas x,y
					//calc the virtual position and paint the pixel
					let rect = event.target.getBoundingClientRect();
					let x = event.clientX - rect.left;
					let y = event.clientY - rect.top;
					console.log(x);
					console.log(y);
					console.log(this);
					console.log(self);
					console.log(self.calcVirtualPixel(x,y));
				}*/

				calcVirtualPixel(xpos, ypos){
					if(xpos < 0 || ypos < 0 || xpos >= this.REAL_WIDTH || ypos >= this.REAL_HEIGHT){
						throw new Error('Coordinates ('+xpos+', '+ypos+') are out of bounds!');
					}

					let virtx = Math.floor(xpos / this.virtualSize);
					let virty = Math.floor(ypos / this.virtualSize);

					return [virtx, virty];
				}

				calcRealPixel(xpos, ypos){
					if(xpos < 0 || ypos < 0 || xpos >= this.virtualSize || ypos >= this.virtualSize){
						throw new Error('Coordinates ('+xpos+', '+ypos+') are out of bounds!');
					}

					let realx = this.pixw * xpos;
					let realy = this.pixh * ypos;
					let endx = realx + this.pixw;
					let endy = realy + this.pixh;

					return {
						startx: realx,
						starty: realy,
						endx: endx,
						endy: endy
					};
				}

				resize(virtualSize){
					this.virtualSize = virtualSize;
					this.pixw = this.REAL_WIDTH / this.virtualSize;
					this.pixh = this.REAL_HEIGHT / this.virtualSize;
				}

				clear(color="black"){
					this.ctx.fillStyle = color;
					this.ctx.fillRect(0,0,this.REAL_WIDTH,this.REAL_HEIGHT);

					//reset state
					this.state = [];
					for(let i=0; i < this.virtualSize; i++){
						this.state[i] = [];
						for(let j=0; j < this.virtualSize; j++){
							this.state[i][j] = 0;
						}
					}
				}

				paintPixel(xpos, ypos, color="white"){
					let realx = xpos * this.pixw;
					let realy = ypos * this.pixh;

					console.log(realx);
					console.log(realy);

					this.ctx.fillStyle = color;
					this.ctx.fillRect(realx, realy, this.pixw, this.pixh);
				}
			}

			document.addEventListener("DOMContentLoaded", function(){
				const c = new Canvas("canvas", 20);
				c.clear();

				c.paintPixel(0,0);
				c.paintPixel(10,10);
			});
		</script>
	</head>
	<body>
		<title>OpenSCAD Texture Editor</title>
		<canvas id="canvas" width="400" height="400">HTML5 Canvas Not Supported!</canvas>
	</body>
</html>